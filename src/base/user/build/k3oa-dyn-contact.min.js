/*! grunt 2017-04-19 */

!function(a){"use strict";a.extend({isValidArray:function(b){return!!(a.isArray(b)&&b.length>0)}});var b,c,d,e,f,g,h,i,j=a.dynbase.extend({_class_name:"cn.firstsoft.firstframe.plugins.dyn.base.service.ContactService",_user_id:void 0,_module:void 0,_dept_cache:{"-1":[]},_isInit:!1,_available:!0,init:function(a,b){var c=this;c._user_id=a.userId,c._module=a.module,c._dept_cache={},c._init(a.server,b)},root:function(b,c){var d=this;a.dyntoast.startLoading(),d._post_ajax_jr("root",b,function(b,e){a.dyntoast.stopLoading(),d._call(c,[b,e])})},list:function(b,c){var d=this;if(void 0!==b){var e=d._dept_cache[b];if(e)return void d._call(c,[!0,e])}a.dyntoast.startLoading(),d._post_ajax_jr("list",[b,!0],function(e,f){a.dyntoast.stopLoading(),!0===e&&(d._dept_cache[b]=f),d._call(c,[e,f])})},query:function(b,c){var d=this;if(!d._available)return void d._call(c,[!1,[]]);var e=[d._user_id,d._module];a.isNumeric(b)&&e.push(b),a.dyntoast.startLoading(),d._post_ajax_jr("query",e,function(b,e){a.dyntoast.stopLoading(),d._call(c,[b,e])})},append:function(b,c){var d=this;if(!d._available)return void d._call(c,[!1,"服务不可用"]);if(a.isArray(b)&&b.length>0){var e=[d._user_id,d._module].concat(b);d._post_ajax_jr("append",e,c)}},search:function(b,c,d){var e=this,f=[b];a.isArray(c)&&(f=f.concat(c)),a.dyntoast.startLoading(),e._post_ajax_jr("search",f,function(b,c){a.dyntoast.stopLoading(),e._call(d,[b,c])})}}),k=a.dynbase.extend("workflow",{_class_name:"cn.firstsoft.firstframe.plugins.dyn.workflow.service.WorkflowService",photoURL:function(a){return this._download("loadPhoto",{params:a})}});b='<div class="aui-content us_12_11"></div>',c='<div class="us-fc" style="display: none;"><div class="us-fc-top"><div class="aui-searchbar-wrap"><div class="aui-searchbar aui-border-radius"><i class="aui-iconfont aui-icon-search"></i><div class="aui-searchbar-text">搜索</div><div class="aui-searchbar-input"><form action="" onsubmit="return false;"><input type="search" name="keyword" placeholder="请输入搜索内容"></form></div><i class="aui-iconfont aui-icon-roundclosefill" style="display: none;"></i></div></div><div class="us-fc-fw"><ul class="aui-list-view"><li class="aui-list-view-cell aui-img"><span class="aui-img-object aui-pull-left"></span><div class="aui-img-body aui-arrow-right"><span class="title">组织架构</span></div></li></ul></div></div><div class="us-fc-content contact"><p class="subtitle">常用联系人</p><ul class="aui-list-view u-list-view"></ul></div><div class="us-fc-content limit "><p class="subtitle">可选成员</p><ul class="aui-list-view u-list-view"></ul></div><div class="us-fc-content search "><p class="subtitle">搜索结果</p><ul class="aui-list-view u-list-view"></ul></div></div>',d='<div class="us-fw" style="display:none;"><div class="us-fw-nav nav"><ul class="title"></ul></div><div class="us-fw-content"><div class="us-fw-leader aui-hidden"><p class="subtitle">负责人</p><ul class="aui-list-view u-list-view"></ul></div><div class="us-fw-user"><p class="subtitle">成员</p><ul class="aui-list-view u-list-view"></ul></div><div class="us-fw-dept"><p class="subtitle">下级部门</p><ul class="aui-list-view"></ul></div></div></div>',e='<div class="us-footer tab"><div class="us-selected"><ul class=""></ul></div><div class="us-btn-wrap"><button class="aui-btn  aui-btn-block cancel">取消</button><button class="aui-btn  aui-btn-block ok">确认</button></div></div>',f='<li class="aui-list-view-cell aui-img"><div class=" aui-pull-left"><i class="aui-iconfont aui-icon-round"></i><img class="aui-img-object photo" src="arch.png"></div><div class="aui-img-body"><span class="name title"></span><p class="duty subtitle"></p></div></li>',g='<li class="aui-list-view-cell"><div class="aui-arrow-right"></div></li>',h='<li><i class="aui-iconfont aui-icon-roundclosefill warn"></i></li>',i="<li></li>";var l=".us-fc .aui-searchbar-wrap .aui-searchbar-input input",m=".us-fc .aui-searchbar-wrap .aui-icon-roundclosefill",n={multiple:!1,contact:{maxCount:5},module:"workflow",server:"../../../..",dept:[],users:[],candidates:[],ok:a.noop,cancel:a.noop},o={onFocus:function(){""!==a(l).val()?a(m).show():a(m).hide()},onBlur:function(){a(".us_12_11 .us-footer").show(),""===a(l).val()&&a(".us-fc .aui-searchbar-wrap").removeClass("focus")},onInput:function(){""!==a(l).val()?a(m).show():a(m).hide()},clearInput:function(){a(l).val(""),a(".us_12_11 .us-fc .us-fc-content").hide().filter(".contact").show(),a(m).hide()},doSearch:function(){a(".us_12_11 .us-footer").hide(),a(".us-fc .aui-searchbar-wrap").addClass("focus"),a(l).focus()},search:function(){var b=this,c=a.trim(a(l).val());""!==c?j.search(c,[],function(c,d){if(!0===c&&d.length>0){a(".us_12_11 .us-fc .us-fc-content").hide();var e=a(".us_12_11 .us-fc .us-fc-content.search");e.show(),b.addUserNodes(e.children("ul"),d)}else 0===d.length&&a.dyntoast.info("无相关成员")}):a.dyntoast.info("关键词不能为空"),a(l).blur()},ok:function(){var b=this,c=[],d=[];a(".us_12_11 .us-footer .us-selected ul li").each(function(b,e){var f=a(this).data("user");c.push(f),d.push(f.id)}),a.isFunction(n.ok)&&n.ok(c),a(".us_12_11, .us_12_11 > .fc, .us_12_11 > .us-fw").hide(),a(".us_12_11 .us-fw .us-fw-nav ul, .us_12_11 .us-fc .us-fc-content ul, .us_12_11 .us-footer .us-selected ul").empty(),b.clearInput(),b.onBlur(),a.extend(n,{candidates:[],dept:[],users:[]}),d.length>0&&j.append(d,a.noop)},cancel:function(){a.isFunction(n.cancel)&&n.cancel(),a(".us_12_11").hide()},init:function(){var b=this;k.init(n.server,function(b,c){!0!==b&&a.dyntoast.error("服务初始化失败")}),j.init({userId:n.uid,module:n.module,server:n.server},function(c,d){!0===c?(j._isInit=!0,j._available=d.available,b.show()):a.dyntoast.error("服务初始化失败")})},addUserNodes:function(b,c){if(b.empty().show(),0===c.length)return void a(".us_12_11 .us-fw .us-fw-user").hide();var d=this;a.isValidArray(c)&&a.each(c,function(a,c){d.addUserNode(b,c)}),0===b.children().length?b.parent().hide():b.parent().show()},addUserNode:function(b,c){var d=this,e=a(f);e.attr("data-id",c.id).data("user",c),e.find("img.photo").attr("src",k.photoURL(c.id)),e.find(".aui-img-body span.name").text(c.name),e.find(".aui-img-body p.duty").text(c.duty),e.bind("click",function(){if(a(this).find("i").hasClass("active"))a(this).find("i").removeClass("active"),a(".us_12_11 .us-footer .us-selected ul").children("li[data-id="+c.id+"]").remove();else{if(!n.multiple&&0!==a(".us_12_11 .us-footer .us-selected ul li").length)return void a.dyntoast.info("已设置单选");d.addSelectedNode(a(".us_12_11 .us-footer .us-selected ul"),c),a(this).find("i").addClass("active")}}),0!==a(".us_12_11 .us-footer .us-selected ul li[data-id="+c.id+"]").length&&e.find("i").addClass("active"),b.append(e)},addDeptNodes:function(b,c){if(b.empty().show(),0===c.length)return void b.parent().hide();var d=this;a.isValidArray(c)&&a.each(c,function(a,c){d.addDeptNode(b,c)}),0===b.children().length?b.parent().hide():b.parent().show()},addDeptNode:function(b,c){var d=this,e=a(g);e.find("div").text(c.name),e.bind("click",function(){j.list(c.id,function(a,b){!0===a&&(d.addNodes(b),d.addNavNode(c))})}),b.append(e)},addSelectedNodes:function(b,c){var d=this;a.each(c,function(a,c){d.addSelectedNode(b,c)})},addSelectedNode:function(b,c){var d=a(h);d.attr("data-id",c.id).data("user",c),d.children("i").bind("click",function(){a(".us_12_11 .us-fc .us-fc-content ul li[data-id="+a(this).parent().attr("data-id")+"]").find("i").removeClass("active"),a(".us_12_11 .us-fw .us-fw-content .us-fw-user ul li[data-id="+a(this).parent().attr("data-id")+"]").find("i").removeClass("active"),a(this).parent().remove()}),d.css("background-image","url("+k.photoURL(c.id)+")"),b.append(d)},addNodes:function(b){var c=this,d=a(".us_12_11 .us-fw .us-fw-user ul").empty().show(),e=a(".us_12_11 .us-fw .us-fw-dept ul").empty().show();a.each(b,function(a,b){void 0!==b.sex?c.addUserNode(d,b):c.addDeptNode(e,b)}),0===d.children().length?d.parent().hide():d.parent().show(),0===e.children().length?e.parent().hide():e.parent().show()},addNavNode:function(b){var c=this,d=a(i);d.attr("data-id",b.id).data("user",b),d.text(b.name),a(".us_12_11 .us-fw .us-fw-nav ul li:last-child").addClass("active").bind("click",function(){var b=this;j.list(a(this).attr("data-id"),function(d,e){!0===d?(c.addNodes(e),a(b).removeClass("active").nextAll().remove(),a(b).unbind("click")):a.dyntoast.error("加载数据出错")})}),d.appendTo(a(".us_12_11 .us-fw .us-fw-nav ul"))},show:function(){var f=this,g=a(".us_12_11");if(0===g.length){g=a(b);var h=a(c);h.find(".aui-searchbar-wrap .aui-searchbar").bind("click",f.doSearch),h.find(".aui-searchbar-wrap .aui-searchbar .aui-searchbar-input input").bind("search",f.search.bind(f)).bind("input",f.onInput).bind("blur",f.onBlur).bind("click",f.onFocus.bind(f)),h.find(".aui-searchbar-wrap .aui-icon-roundclosefill").bind("click",f.clearInput),h.find(".us-fc-fw ul li").bind("click",function(){g.find(".us-fc").hide(),j.list(0,function(b,c){!0===b?(f.addNavNode(c[0]),j.list(c[0].id,function(a,b){!0===a&&f.addNodes(b)}),g.find(".us-fw").show()):a.dyntoast.error("获取组织树出错")})}),h.appendTo(g);a(d).appendTo(g);var i=a(e);i.find(".us-btn-wrap button.ok").bind("click",f.ok.bind(f)),i.find(".us-btn-wrap button.cancel").bind("click",f.cancel.bind(f)),i.appendTo(g),g.appendTo(a("body"))}g.show(),f.addSelectedNodes(g.find(".us-footer .us-selected ul"),n.users),a.isValidArray(n.candidates)?(g.find(".us-fc > .us-fc-top, .us-fc > .us-fc-content").hide(),f.addUserNodes(g.find(".us-fc .us-fc-content.limit ul"),n.candidates),g.find(".us-fc, .us-fc > .us-fc-content.limit").show()):a.isValidArray(n.dept)?(g.find(".us-fc, .us-fc > .us-fc-top, .us-fc > .us-fc-content").hide(),j.root(n.dept,function(b,c){if(!0===b&&c.length>0){j._dept_cache[-1]=c,g.find(".us-fw .us-fw-nav ul").empty(),f.addNavNode({id:-1,name:"候选部门",type:-1});var d=g.find(".us-fw .us-fw-dept");d.show(),f.addDeptNodes(d.children("ul"),c),g.find(".us-fw .us-fw-user").hide(),g.find(".us-fw .us-fw-dept ul").show(),g.find(".us-fw").show()}else a.dyntoast.warn("无效的部门编号")})):(g.find(".us-fc, .us-fc > .us-fc-top, .us-fc > .us-fc-content.contact").show(),j.query(n.count,function(a,b){!0===a&&b.length>0?(g.find(".us-fc .us-fc-content.contact").show(),f.addUserNodes(g.find(".us-fc .us-fc-content.contact ul"),b)):g.find(".us-fc .us-fc-content.contact").hide()}))}};a.extend({showContact:function(b){a.extend(n,b||{}),j._isInit?o.show():o.init()}})}(jQuery);